<!doctype html>
<html>
  <head>
    <title>Hi9 Deko</title>
    <script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="/bower_components/iron-location/iron-location.html">
    <link rel="import" href="/bower_components/card-display/card-display.html">
    <link rel="import" href="/bower_components/iron-localstorage/iron-localstorage.html">
    <link rel="import" href="/bower_components/paper-button/paper-button.html">
    <link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
  </head>
  <body>
    <add-card></add-card>
  </body>
</html>


<!--
`<add-card></add-card>` 
@demo demo.html
-->

<dom-module id="add-card">
  <template>
    <center><h1>{{title}}</h1></center>
    <iron-localstorage name="addme" value="{{addme}}"></iron-localstorage>
    <card-display id="cardDisplay" selected="{{selected}}" selectable cards="{{cards}}"></card-display>
    <paper-toolbar style="position:fixed;bottom:0;right:0;width:100%">
      <span class="flex"></span>
      <template is="dom-if" if="{{selected.length}}">
        <paper-button on-tap="addThese" raised><iron-icon icon="done"></iron-icon>Add</paper-button>
      </template>
      <template is="dom-if" if="{{selectable}}">
        <template is="dom-if" if="{{!selected.length}}">
          <template is="dom-if" if="{{!title}}">
            <paper-button on-tap="addAll" raised><iron-icon icon="done"></iron-icon>Add All</paper-button>
          </template>
          <template is="dom-if" if="{{title}}">
            <paper-button on-tap="addAll" raised><iron-icon icon="done"></iron-icon>Add Deko</paper-button>
          </template>
        </template>
      </template>
      <paper-button raised on-tap="goHome"><iron-icon icon="cancel"></iron-icon>Cancel</paper-button>
    </paper-toolbar>
  </template>
</dom-module>
<script>
Polymer({
  is: "add-card",
  properties: {
    cards: {
        type:Array,
        value:[{"title":"a","url":"/a"},{"title":"b","url":"/b"},{"title":"c","url":"/c"}],
    },
    title: {value:"Hi9 Deko"},
    selectedCards: {computed: "getCards(selected.*)"},
    selected: {value: [], type: Array}
  },
  hash: function(it) {
    return this.$.cardDisplay.hash(it)
  },
  add: function(e) {
    if (!this.addme) {
      this.addme = {}
    }
    var hash = this.hash(this.cards[e.detail].url)
    this.set("addme." + hash, this.cards[e.detail])
    setTimeout(function(){ window.location.href = '/' }, 100)
  },
  addThese: function() {
    if (!this.addme) {
      this.addme = {}
    }
    for (card in this.selectedCards) {
      var hash = this.hash(card.url)
      this.set("addme." + hash, card)
    }
    setTimeout(function(){ window.location.href = '/' }, 100)
  },
  addAll: function() {
    if (Array.isArray(this.data)) {
      if (this.data.length === 1 && this.data[0].data && this.data[0].title) {
        this.cards = this.data
      }
    }
    if (!this.addme) {
      this.addme = {}
    }
    
    for (card in this.cards) {
      var hash = this.hash(card.url)
      this.set("addme." + hash, card)
    }
    setTimeout(function(){ window.location.href = '/' }, 100)
  },
  goHome: function() {
    window.location.href = '/'
  },
  getCards: function(selected) {
    var cards = []
    for (var i = 0; i < selected.base.length; i++) {
      cards.push(this.cards[selected.base[i]])
    }
    return cards
  }
})
</script>
